---
- name: Update system packages
  apt:
    update_cache: yes
  become: true
  register: apt_update
  failed_when: apt_update is failed

- name: Install dependencies
  apt:
    name: 
      - gnupg
      - curl
      - haveged
    state: present
  become: true
  register: deps_result
  failed_when: deps_result is failed

- name: Ensure haveged is running for entropy
  service:
    name: haveged
    state: started
    enabled: yes
  become: true
  ignore_errors: yes

- name: Download MongoDB GPG key
  shell: "curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg"
  args:
    creates: /usr/share/keyrings/mongodb-server-7.0.gpg
  become: true
  register: gpg_result
  failed_when: gpg_result is failed
  when: ansible_distribution == "Ubuntu"

- name: Remove incorrect MongoDB repository file
  file:
    path: /etc/apt/sources.list.d/mongodb-org-7.0.list
    state: absent
  become: true

- name: Add MongoDB repository
  shell: echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu {{ ansible_distribution_release }}/mongodb-org/7.0 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-7.0.list
  become: true
  register: repo_result
  failed_when: repo_result is failed

- name: Update package lists
  apt:
    update_cache: yes
  become: true
  register: apt_update_after_repo
  retries: 3
  delay: 5
  until: apt_update_after_repo is success

- name: Install MongoDB packages
  apt:
    name: mongodb-org
    state: present
  become: true
  register: mongodb_install
  failed_when: mongodb_install is failed

- name: Create MongoDB configuration
  template:
    src: mongod.conf.j2
    dest: /etc/mongod.conf
    owner: root
    group: root
    mode: 0644
  become: true
  notify: restart mongodb

- name: Add MongoDB directories
  file:
    state: directory
    path: "{{ item }}"
    owner: "{{ mongodb_user | default('mongodb') }}"
    group: "{{ mongodb_group | default('mongodb') }}"
    mode: 0755
  with_items:
    - "{{ mongodb_dbpath | default('/var/lib/mongodb') }}"
    - "{{ mongodb_security_path | default('/var/lib/mongodb/security') }}"
    - "{{ mongodb_logpath | dirname | default('/var/log/mongodb') }}"
  become: true

- name: Set appropriate permissions on data directory
  file:
    path: "{{ mongodb_dbpath | default('/var/lib/mongodb') }}"
    state: directory
    owner: "{{ mongodb_user | default('mongodb') }}"
    group: "{{ mongodb_group | default('mongodb') }}"
    mode: 0750
    recurse: yes
  become: true

- name: Create MongoDB keyfile from base64
  block:
    - name: Create temp file for keyfile
      tempfile:
        state: file
        suffix: keyfile
      register: temp_keyfile
      when: mongodb_keyfile is defined and mongodb_keyfile

    - name: Decode keyfile to temp file
      copy:
        content: "{{ mongodb_keyfile | b64decode }}"
        dest: "{{ temp_keyfile.path }}"
        mode: 0600
      when: mongodb_keyfile is defined and mongodb_keyfile and temp_keyfile.path is defined

    - name: Copy keyfile to destination
      copy:
        src: "{{ temp_keyfile.path }}"
        dest: "{{ mongodb_security_path | default('/var/lib/mongodb/security') }}/keyfile"
        owner: "{{ mongodb_user | default('mongodb') }}"
        group: "{{ mongodb_group | default('mongodb') }}"
        mode: 0600
        remote_src: yes
      notify: restart mongodb
      when: mongodb_keyfile is defined and mongodb_keyfile and temp_keyfile.path is defined
  become: true
  when: mongodb_keyfile is defined and mongodb_keyfile

- name: Create MongoDB PEM from base64
  block:
    - name: Create temp file for PEM
      tempfile:
        state: file
        suffix: pem
      register: temp_pem
      when: mongodb_pem is defined and mongodb_pem

    - name: Decode PEM to temp file
      copy:
        content: "{{ mongodb_pem | b64decode }}"
        dest: "{{ temp_pem.path }}"
        mode: 0600
      when: mongodb_pem is defined and mongodb_pem and temp_pem.path is defined

    - name: Copy PEM to destination
      copy:
        src: "{{ temp_pem.path }}"
        dest: "{{ mongodb_security_path | default('/var/lib/mongodb/security') }}/mongodb.pem"
        owner: "{{ mongodb_user | default('mongodb') }}"
        group: "{{ mongodb_group | default('mongodb') }}"
        mode: 0600
        remote_src: yes
      notify: restart mongodb
      when: mongodb_pem is defined and mongodb_pem and temp_pem.path is defined
  become: true
  when: mongodb_pem is defined and mongodb_pem

- name: Reload systemd after service file changes
  systemd:
    daemon_reload: yes
  become: true

- name: Enable and start MongoDB service
  service:
    name: "{{ mongodb_service_name | default('mongod') }}"
    enabled: yes
    state: started
  become: true

- name: Verify MongoDB installation
  command: mongod --version
  become: true
  register: version_check
  changed_when: false
  failed_when: false

- name: Show MongoDB verification results
  debug:
    msg: "MongoDB installation verified successfully. Version: {{ version_check.stdout_lines[0] if version_check.rc == 0 else 'MongoDB verification failed!' }}"

- name: Get MongoDB service status
  command: systemctl status mongod
  become: true
  register: status_result
  changed_when: false
  failed_when: false

- name: Show MongoDB service status
  debug:
    msg: "{{ status_result.stdout_lines }}"